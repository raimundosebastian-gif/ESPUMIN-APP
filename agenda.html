<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPUMIN - Agenda</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Menú -->
    <div id="menu-container"></div>

    <main class="modulo-container">
        <h1>Agenda</h1>
        <button class="btn-volver" onclick="window.location.href='menu.html'">Volver al menú</button>

        <!-- Botón volver -->
        <button class="btn-volver" onclick="window.location.href='menu.html'">Volver al menú</button>

        <!-- Formulario -->
        <section class="form-section">
            <input type="hidden" id="id">

            <label for="titulo">Título</label>
            <input type="text" id="titulo" placeholder="Ej: Llamar a proveedor, entrega, reunión">

            <label for="fecha">Fecha</label>
            <input type="date" id="fecha">

            <label for="hora">Hora</label>
            <input type="time" id="hora">

            <label for="estado">Estado</label>
            <select id="estado">
                <option value="Pendiente">Pendiente</option>
                <option value="En proceso">En proceso</option>
                <option value="Completado">Completado</option>
            </select>

            <button id="guardarBtn">Guardar</button>
            <button id="cancelarBtn" class="btn-secundario">Cancelar</button>
        </section>

        <!-- Tabla -->
        <section class="tabla-section">
            <table>
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaAgenda"></tbody>
            </table>
        </section>
    </main>

    <script src="core.js"></script>
    <script>
        protegerModulo();

        // Cargar menú desde fragmento
        fetch("menu-fragment.html")
            .then(r => r.text())
            .then(html => {
                document.getElementById("menu-container").innerHTML = html;

                const usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
                if (usuario) {
                    document.getElementById("usuarioActual").textContent = usuario.usuario;
                } else {
                    window.location.href = "login.html";
                }
            });

        // Renderizar tabla
        function cargarTabla() {
            const agenda = getData("agenda");
            const tbody = document.getElementById("tablaAgenda");
            tbody.innerHTML = "";

            agenda.forEach(ev => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${ev.titulo}</td>
                    <td>${formatDate(ev.fecha)}</td>
                    <td>${ev.hora}</td>
                    <td>${ev.estado}</td>
                    <td>
                        <button onclick="editar('${ev.id}')">Editar</button>
                        <button onclick="eliminar('${ev.id}')" class="btn-eliminar">Eliminar</button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Guardar evento
        document.getElementById("guardarBtn").addEventListener("click", () => {
            const id = document.getElementById("id").value;
            const titulo = document.getElementById("titulo").value.trim();
            const fecha = document.getElementById("fecha").value;
            const hora = document.getElementById("hora").value;
            const estado = document.getElementById("estado").value;

            if (!titulo || !fecha || !hora) {
                alert("Complete todos los campos");
                return;
            }

            let agenda = getData("agenda");

            if (id) {
                // Editar
                const ev = agenda.find(a => a.id === id);
                ev.titulo = titulo;
                ev.fecha = fecha;
                ev.hora = hora;
                ev.estado = estado;

                registrarAuditoria("Agenda", "Edición", `Editó evento: ${titulo}`);
            } else {
                // Nuevo
                agenda.push({
                    id: generarID(),
                    titulo,
                    fecha,
                    hora,
                    estado
                });

                registrarAuditoria("Agenda", "Alta", `Agregó evento: ${titulo}`);
            }

            setData("agenda", agenda);
            limpiarFormulario();
            cargarTabla();
        });

        // Editar
        function editar(id) {
            const ev = getData("agenda").find(a => a.id === id);
            document.getElementById("id").value = ev.id;
            document.getElementById("titulo").value = ev.titulo;
            document.getElementById("fecha").value = ev.fecha;
            document.getElementById("hora").value = ev.hora;
            document.getElementById("estado").value = ev.estado;
        }

        // Eliminar
        function eliminar(id) {
            if (!confirm("¿Eliminar evento?")) return;

            let agenda = getData("agenda");
            const ev = agenda.find(a => a.id === id);

            agenda = agenda.filter(a => a.id !== id);
            setData("agenda", agenda);

            registrarAuditoria("Agenda", "Baja", `Eliminó evento: ${ev.titulo}`);

            cargarTabla();
        }

        // Cancelar
        document.getElementById("cancelarBtn").addEventListener("click", limpiarFormulario);

        function limpiarFormulario() {
            document.getElementById("id").value = "";
            document.getElementById("titulo").value = "";
            document.getElementById("fecha").value = "";
            document.getElementById("hora").value = "";
        }

        // Inicializar
        cargarTabla();
    </script>

</body>
</html>
