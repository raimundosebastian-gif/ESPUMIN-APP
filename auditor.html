<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Auditor칤a m칩dulos ERP</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    h1 { margin-top:0; }
    .card { background:#fff; border-radius:8px; padding:16px 20px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
    .ok { color:#0a7a2f; font-weight:600; }
    .error { color:#b00020; font-weight:600; }
    .warn { color:#c77700; font-weight:600; }
    code { background:#eee; padding:2px 4px; border-radius:4px; font-size:0.9em; }
    ul { margin-top:6px; margin-bottom:6px; }
    .small { font-size:0.85em; color:#555; }
  </style>
</head>
<body>
  <h1>Auditor칤a de m칩dulos ERP</h1>
  <p class="small">
    Este archivo verifica rutas, carga de scripts y elementos clave de: <strong>agenda</strong>, <strong>inventario</strong> y <strong>ventas</strong>.
  </p>

  <div id="results"></div>

  <script>
    // 游댢 CONFIGURACI칍N: ajust치 rutas si algo cambia
    const modules = [
      {
        name: "Agenda",
        pages: [
          { label: "Agenda principal", path: "agenda.html" }
        ],
        requiredScripts: ["agenda.js"],
        requiredSelectors: [
          { desc: "Selector de sucursal", selector: "select[id*='sucursal'], select[name*='sucursal']" },
          { desc: "Tabla principal", selector: "table" }
        ]
      },
      {
        name: "Inventario",
        pages: [
          { label: "Listado inventario", path: "listado-inventario.html" },
          { label: "Ingreso inventario", path: "ingreso-inventario.html" },
          { label: "Salida inventario", path: "salida-inventario.html" },
          { label: "Movimientos inventario", path: "movimientos-inventario.html" },
          { label: "Kardex", path: "kardex.html" }
        ],
        requiredScripts: ["inventario.js"],
        requiredSelectors: [
          { desc: "Selector de sucursal", selector: "select[id*='sucursal'], select[name*='sucursal']" },
          { desc: "Tabla de movimientos / listado", selector: "table" }
        ]
      },
      {
        name: "Ventas",
        pages: [
          { label: "Listado ventas", path: "listado-ventas.html" },
          { label: "Nueva venta", path: "nueva-venta.html" },
          { label: "Movimientos ventas", path: "movimientos-ventas.html" }
        ],
        requiredScripts: ["ventas.js"],
        requiredSelectors: [
          { desc: "Selector de sucursal", selector: "select[id*='sucursal'], select[name*='sucursal']" },
          { desc: "Tabla de ventas / movimientos", selector: "table" }
        ]
      }
    ];

    const menuChecks = [
      {
        name: "Menu fragment",
        path: "menu-fragment.html",
        requiredLinks: [
          { desc: "Link a Agenda", textIncludes: "Agenda" },
          { desc: "Link a Inventario", textIncludes: "Inventario" },
          { desc: "Link a Ventas", textIncludes: "Ventas" }
        ]
      }
    ];

    const resultsDiv = document.getElementById("results");

    function addCard(html) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = html;
      resultsDiv.appendChild(div);
    }

    async function fetchPage(path) {
      try {
        const res = await fetch(path, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/html");
        return { ok: true, doc, error: null };
      } catch (e) {
        return { ok: false, doc: null, error: e.message };
      }
    }

    function checkScripts(doc, requiredScripts) {
      const scripts = Array.from(doc.querySelectorAll("script[src]"))
        .map(s => s.getAttribute("src") || "");
      const missing = requiredScripts.filter(req =>
        !scripts.some(src => src.endsWith("/" + req) || src === req)
      );
      return { scripts, missing };
    }

    function checkSelectors(doc, requiredSelectors) {
      return requiredSelectors.map(r => {
        const found = !!doc.querySelector(r.selector);
        return { desc: r.desc, selector: r.selector, found };
      });
    }

    function checkDuplicateIds(doc) {
      const all = Array.from(doc.querySelectorAll("[id]")).map(el => el.id);
      const seen = new Set();
      const dup = new Set();
      all.forEach(id => {
        if (seen.has(id)) dup.add(id);
        else seen.add(id);
      });
      return Array.from(dup);
    }

    function checkMenuLinks(doc, requiredLinks) {
      const links = Array.from(doc.querySelectorAll("a, button"));
      return requiredLinks.map(r => {
        const found = links.some(el =>
          (el.textContent || "").toLowerCase().includes(r.textIncludes.toLowerCase())
        );
        return { desc: r.desc, textIncludes: r.textIncludes, found };
      });
    }

    async function auditModules() {
      // Auditor칤a de men칰
      for (const menu of menuChecks) {
        const res = await fetchPage(menu.path);
        if (!res.ok) {
          addCard(`
            <h2>Men칰: ${menu.name}</h2>
            <p class="error">No se pudo cargar <code>${menu.path}</code>: ${res.error}</p>
          `);
        } else {
          const linkChecks = checkMenuLinks(res.doc, menu.requiredLinks);
          addCard(`
            <h2>Men칰: ${menu.name}</h2>
            <p><strong>Archivo:</strong> <code>${menu.path}</code></p>
            <ul>
              ${linkChecks.map(c => `
                <li>
                  <span class="${c.found ? "ok" : "error"}">
                    ${c.found ? "OK" : "FALTA"}:
                  </span>
                  ${c.desc} (texto contiene: <code>${c.textIncludes}</code>)
                </li>
              `).join("")}
            </ul>
          `);
        }
      }

      // Auditor칤a de m칩dulos
      for (const mod of modules) {
        let html = `<h2>M칩dulo: ${mod.name}</h2><ul>`;
        for (const page of mod.pages) {
          const res = await fetchPage(page.path);
          if (!res.ok) {
            html += `
              <li>
                <span class="error">ERROR:</span>
                No se pudo cargar <strong>${page.label}</strong> (<code>${page.path}</code>): ${res.error}
              </li>
            `;
            continue;
          }

          const { scripts, missing } = checkScripts(res.doc, mod.requiredScripts);
          const selectorChecks = checkSelectors(res.doc, mod.requiredSelectors);
          const dupIds = checkDuplicateIds(res.doc);

          html += `
            <li>
              <strong>${page.label}</strong> (<code>${page.path}</code>)
              <ul>
                <li>
                  <strong>Scripts encontrados:</strong>
                  ${scripts.length ? scripts.map(s => `<code>${s}</code>`).join(", ") : "<span class='warn'>ninguno</span>"}
                </li>
                <li>
                  <strong>Scripts requeridos:</strong>
                  ${mod.requiredScripts.map(s => {
                    const ok = !missing.includes(s);
                    return `<span class="${ok ? "ok" : "error"}">${ok ? "OK" : "FALTA"} <code>${s}</code></span>`;
                  }).join(" | ")}
                </li>
                <li>
                  <strong>Elementos clave:</strong>
                  <ul>
                    ${selectorChecks.map(c => `
                      <li>
                        <span class="${c.found ? "ok" : "error"}">
                          ${c.found ? "OK" : "NO ENCONTRADO"}:
                        </span>
                        ${c.desc} <span class="small">(selector: <code>${c.selector}</code>)</span>
                      </li>
                    `).join("")}
                  </ul>
                </li>
                <li>
                  <strong>IDs duplicados en la p치gina:</strong>
                  ${dupIds.length
                    ? `<span class="warn">${dupIds.map(id => `<code>${id}</code>`).join(", ")}</span>`
                    : "<span class='ok'>Sin duplicados</span>"
                  }
                </li>
              </ul>
            </li>
          `;
        }
        html += "</ul>";
        addCard(html);
      }
    }

    auditModules();
  </script>
</body>
</html>
