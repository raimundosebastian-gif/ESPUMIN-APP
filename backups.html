<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPUMIN - Backups</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Menú -->
    <div id="menu-container"></div>

    <main class="modulo-container">
        <h1>Backups</h1>

        <!-- Exportar -->
        <section class="form-section">
            <h2>Exportar datos</h2>
            <p>Genera un archivo JSON con toda la información del sistema.</p>
            <button id="exportarBtn">Exportar Backup</button>
        </section>

        <!-- Importar -->
        <section class="form-section">
            <h2>Importar datos</h2>
            <p>Selecciona un archivo JSON previamente exportado.</p>
            <input type="file" id="importarArchivo" accept=".json">
            <button id="importarBtn">Importar Backup</button>
        </section>

        <!-- Historial -->
        <section class="tabla-section">
            <h2>Historial de Backups</h2>
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="tablaBackups"></tbody>
            </table>
        </section>
    </main>

    <script src="core.js"></script>
    <script>
        protegerModulo();

        // Cargar menú
        fetch("menu.html")
            .then(r => r.text())
            .then(html => document.getElementById("menu-container").innerHTML = html);

        // Renderizar historial
        function cargarTabla() {
            const backups = getData("backups");
            const tbody = document.getElementById("tablaBackups");
            tbody.innerHTML = "";

            backups.forEach(b => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${formatDate(b.fecha)}</td>
                    <td>${b.accion}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Exportar backup
        document.getElementById("exportarBtn").addEventListener("click", () => {
            const data = localStorage;
            const json = JSON.stringify(data, null, 2);

            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "backup_espumin.json";
            a.click();

            registrarAuditoria("Backups", "Exportación", "Exportó backup completo");

            let backups = getData("backups");
            backups.push({
                id: generarID(),
                fecha: new Date().toISOString(),
                accion: "Exportación"
            });
            setData("backups", backups);

            cargarTabla();
        });

        // Importar backup
        document.getElementById("importarBtn").addEventListener("click", () => {
            const archivo = document.getElementById("importarArchivo").files[0];

            if (!archivo) {
                alert("Seleccione un archivo JSON");
                return;
            }

            const lector = new FileReader();
            lector.onload = function(e) {
                try {
                    const datos = JSON.parse(e.target.result);

                    for (let key in datos) {
                        localStorage.setItem(key, datos[key]);
                    }

                    registrarAuditoria("Backups", "Importación", "Importó backup completo");

                    let backups = getData("backups");
                    backups.push({
                        id: generarID(),
                        fecha: new Date().toISOString(),
                        accion: "Importación"
                    });
                    setData("backups", backups);

                    alert("Backup importado correctamente");
                    cargarTabla();
                } catch (err) {
                    alert("Archivo inválido");
                }
            };

            lector.readAsText(archivo);
        });

        // Inicializar
        cargarTabla();
    </script>

</body>
</html>
