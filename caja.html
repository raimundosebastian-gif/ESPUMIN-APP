<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caja / Tesorer√≠a</title>
    <link rel="stylesheet" href="style.css">
    <script src="js/core.js"></script>
</head>

<body onload="protegerModulo(); cargarCaja();">

    <!-- ENCABEZADO -->
    <header class="header">
        <h1>Caja / Tesorer√≠a</h1>
        <button class="btn-primary" onclick="abrirModal()">Nuevo movimiento</button>
    </header>

    <!-- FILTROS -->
    <section class="filtros">
        <input type="date" id="filtroFecha">
        <select id="filtroTipo">
            <option value="">Todos</option>
            <option value="ingreso">Ingreso</option>
            <option value="egreso">Egreso</option>
        </select>
        <button class="btn-secondary" onclick="cargarCaja()">Filtrar</button>
    </section>

    <!-- TABLA -->
    <section class="tabla-contenedor">
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Monto</th>
                    <th>Cuenta</th>
                    <th>Descripci√≥n</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tablaCaja"></tbody>
        </table>
    </section>

    <!-- MODAL -->
    <div id="modalCaja" class="modal">
        <div class="modal-contenido">
            <h2 id="modalTitulo">Nuevo movimiento</h2>

            <input type="hidden" id="movId">

            <label>Fecha</label>
            <input type="date" id="movFecha">

            <label>Tipo</label>
            <select id="movTipo">
                <option value="ingreso">Ingreso</option>
                <option value="egreso">Egreso</option>
            </select>

            <label>Monto</label>
            <input type="number" id="movMonto" min="0" step="0.01">

            <label>Cuenta</label>
            <input type="text" id="movCuenta" placeholder="Caja principal, Banco, etc.">

            <label>Descripci√≥n</label>
            <textarea id="movDescripcion"></textarea>

            <div class="modal-botones">
                <button class="btn-primary" onclick="guardarMovimiento()">Guardar</button>
                <button class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        /* ============================
           CARGA DE TABLA
        ============================ */
        function cargarCaja() {
            const fechaFiltro = document.getElementById("filtroFecha").value;
            const tipoFiltro = document.getElementById("filtroTipo").value;

            let movimientos = getCaja();

            if (fechaFiltro) {
                movimientos = movimientos.filter(m => m.fecha.startsWith(fechaFiltro));
            }

            if (tipoFiltro) {
                movimientos = movimientos.filter(m => m.tipo === tipoFiltro);
            }

            const tbody = document.getElementById("tablaCaja");
            tbody.innerHTML = "";

            movimientos.forEach(m => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${formatDate(m.fecha)}</td>
                    <td>${m.tipo.toUpperCase()}</td>
                    <td>${formatCurrency(m.monto)}</td>
                    <td>${m.cuenta}</td>
                    <td>${m.descripcion}</td>
                    <td>
                        <button class="btn-small" onclick="editarMovimiento(${m.id})">‚úèÔ∏è</button>
                        <button class="btn-small btn-danger" onclick="eliminarMovimiento(${m.id})">üóëÔ∏è</button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        /* ============================
           MODAL
        ============================ */
        function abrirModal() {
            document.getElementById("modalCaja").style.display = "flex";
            document.getElementById("modalTitulo").innerText = "Nuevo movimiento";
            document.getElementById("movId").value = "";
            document.getElementById("movFecha").value = new Date().toISOString().split("T")[0];
            document.getElementById("movTipo").value = "ingreso";
            document.getElementById("movMonto").value = "";
            document.getElementById("movCuenta").value = "";
            document.getElementById("movDescripcion").value = "";
        }

        function cerrarModal() {
            document.getElementById("modalCaja").style.display = "none";
        }

        /* ============================
           CRUD
        ============================ */
        function guardarMovimiento() {
            const id = document.getElementById("movId").value;
            const fecha = document.getElementById("movFecha").value;
            const tipo = document.getElementById("movTipo").value;
            const monto = parseFloat(document.getElementById("movMonto").value);
            const cuenta = document.getElementById("movCuenta").value;
            const descripcion = document.getElementById("movDescripcion").value;

            if (!validarCampos([fecha, tipo, monto, cuenta])) {
                alert("Todos los campos obligatorios deben estar completos.");
                return;
            }

            const mov = { id: id || generarID(), fecha, tipo, monto, cuenta, descripcion };

            if (id) {
                updateCaja(parseInt(id), mov);
            } else {
                addCaja(mov);
            }

            cerrarModal();
            cargarCaja();
        }

        function editarMovimiento(id) {
            const mov = getCaja().find(m => m.id === id);

            abrirModal();
            document.getElementById("modalTitulo").innerText = "Editar movimiento";

            document.getElementById("movId").value = mov.id;
            document.getElementById("movFecha").value = mov.fecha;
            document.getElementById("movTipo").value = mov.tipo;
            document.getElementById("movMonto").value = mov.monto;
            document.getElementById("movCuenta").value = mov.cuenta;
            document.getElementById("movDescripcion").value = mov.descripcion;
        }

        function eliminarMovimiento(id) {
            if (confirm("¬øEliminar este movimiento?")) {
                deleteCaja(id);
                cargarCaja();
            }
        }
    </script>

</body>
</html>
