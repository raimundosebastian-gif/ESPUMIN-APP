<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPUMIN - Caja / Tesorería</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Menú -->
    <div id="menu-container"></div>

    <main class="modulo-container">
        <h1>Caja / Tesorería</h1>

        <!-- Formulario -->
        <section class="form-section">
            <input type="hidden" id="id">

            <label>Tipo de movimiento</label>
            <select id="tipo">
                <option value="Ingreso">Ingreso</option>
                <option value="Egreso">Egreso</option>
            </select>

            <label>Monto ($)</label>
            <input type="number" id="monto" placeholder="Ej: 5000">

            <label>Detalle</label>
            <input type="text" id="detalle" placeholder="Ej: Pago cliente, compra insumos">

            <button id="guardarBtn">Registrar</button>
            <button id="cancelarBtn" class="btn-secundario">Cancelar</button>
        </section>

        <!-- Saldo -->
        <section class="saldo-section">
            <h2>Saldo actual: $ <span id="saldoActual">0</span></h2>
        </section>

        <!-- Tabla -->
        <section class="tabla-section">
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Monto</th>
                        <th>Detalle</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaCaja"></tbody>
            </table>
        </section>
    </main>

    <script src="js/core.js"></script>
    <script>
        protegerModulo();

        // Cargar menú
        fetch("menu.html")
            .then(r => r.text())
            .then(html => document.getElementById("menu-container").innerHTML = html);

        // Calcular saldo
        function calcularSaldo() {
            const movimientos = getData("caja");
            let saldo = 0;

            movimientos.forEach(m => {
                if (m.tipo === "Ingreso") saldo += m.monto;
                else saldo -= m.monto;
            });

            document.getElementById("saldoActual").textContent = saldo;
        }

        // Renderizar tabla
        function cargarTabla() {
            const movimientos = getData("caja");
            const tbody = document.getElementById("tablaCaja");
            tbody.innerHTML = "";

            movimientos.forEach(m => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${formatDate(m.fecha)}</td>
                    <td>${m.tipo}</td>
                    <td>$ ${m.monto}</td>
                    <td>${m.detalle}</td>
                    <td>
                        <button onclick="eliminar('${m.id}')" class="btn-eliminar">Eliminar</button>
                    </td>
                `;

                tbody.appendChild(tr);
            });

            calcularSaldo();
        }

        // Guardar movimiento
        document.getElementById("guardarBtn").addEventListener("click", () => {
            const tipo = document.getElementById("tipo").value;
            const monto = Number(document.getElementById("monto").value);
            const detalle = document.getElementById("detalle").value.trim();

            if (!monto || monto <= 0) {
                alert("Ingrese un monto válido");
                return;
            }

            let movimientos = getData("caja");

            movimientos.push({
                id: generarID(),
                fecha: new Date().toISOString(),
                tipo,
                monto,
                detalle
            });

            setData("caja", movimientos);

            registrarAuditoria("Caja", "Alta", `${tipo} - $${monto} (${detalle})`);

            limpiarFormulario();
            cargarTabla();
        });

        // Eliminar movimiento
        function eliminar(id) {
            if (!confirm("¿Eliminar movimiento?")) return;

            let movimientos = getData("caja");
            const mov = movimientos.find(m => m.id === id);

            movimientos = movimientos.filter(m => m.id !== id);
            setData("caja", movimientos);

            registrarAuditoria("Caja", "Baja", `Eliminó movimiento: ${mov.tipo} - $${mov.monto}`);

            cargarTabla();
        }

        // Cancelar
        document.getElementById("cancelarBtn").addEventListener("click", limpiarFormulario);

        function limpiarFormulario() {
            document.getElementById("monto").value = "";
            document.getElementById("detalle").value = "";
        }

        // Inicializar
        cargarTabla();
    </script>

</body>
</html>
