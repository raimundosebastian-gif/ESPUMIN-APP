<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPUMIN - Clientes</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Menú -->
    <div id="menu-container"></div>

    <main class="modulo-container">
        <h1>Clientes</h1>

        <!-- Formulario -->
        <section class="form-section">
            <input type="hidden" id="id">

            <label for="nombre">Nombre</label>
            <input type="text" id="nombre" placeholder="Ej: Juan" onblur="capitalizarInput(this)">

            <label for="apellido">Apellido</label>
            <input type="text" id="apellido" placeholder="Ej: Pérez" onblur="capitalizarInput(this)">

            <label for="telefono">Teléfono</label>
            <input type="text" id="telefono" placeholder="Ej: 1122334455">

            <button id="guardarBtn">Guardar</button>
            <button id="cancelarBtn" class="btn-secundario">Cancelar</button>
        </section>

        <!-- Tabla -->
        <section class="tabla-section">
            <input type="text" id="buscar" placeholder="Buscar..." onkeyup="cargarTabla()">

            <table>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Teléfono</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaClientes"></tbody>
            </table>
        </section>
    </main>

    <script src="core.js"></script>
    <script>
        // Seguridad
        protegerModulo();

        // Cargar menú
        fetch("menu.html")
            .then(r => r.text())
            .then(html => document.getElementById("menu-container").innerHTML = html);

        // Capitalizar
        function capitalizarInput(input) {
            input.value = input.value
                .trim()
                .split(" ")
                .filter(p => p.length > 0)
                .map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase())
                .join(" ");
        }

        // Renderizar tabla
        function cargarTabla() {
            const clientes = getData("clientes");
            const filtro = document.getElementById("buscar").value.toLowerCase();
            const tbody = document.getElementById("tablaClientes");
            tbody.innerHTML = "";

            clientes
                .filter(c =>
                    c.nombre.toLowerCase().includes(filtro) ||
                    c.apellido.toLowerCase().includes(filtro) ||
                    c.telefono.includes(filtro)
                )
                .forEach(cli => {
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
                        <td>${cli.nombre}</td>
                        <td>${cli.apellido}</td>
                        <td>${cli.telefono}</td>
                        <td>
                            <button onclick="editar('${cli.id}')">Editar</button>
                            <button onclick="eliminar('${cli.id}')" class="btn-eliminar">Eliminar</button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
        }

        // Guardar cliente
        document.getElementById("guardarBtn").addEventListener("click", () => {
            const id = document.getElementById("id").value;
            const nombre = document.getElementById("nombre").value.trim();
            const apellido = document.getElementById("apellido").value.trim();
            const telefono = document.getElementById("telefono").value.trim();

            if (!nombre || !apellido || !telefono) {
                alert("Complete todos los campos");
                return;
            }

            let clientes = getData("clientes");

            if (id) {
                // Editar
                const cli = clientes.find(c => c.id === id);
                cli.nombre = nombre;
                cli.apellido = apellido;
                cli.telefono = telefono;

                registrarAuditoria("Clientes", "Edición", `Editó cliente ${nombre} ${apellido}`);
            } else {
                // Nuevo
                clientes.push({
                    id: generarID(),
                    nombre,
                    apellido,
                    telefono
                });

                registrarAuditoria("Clientes", "Alta", `Creó cliente ${nombre} ${apellido}`);
            }

            setData("clientes", clientes);
            limpiarFormulario();
            cargarTabla();
        });

        // Editar
        function editar(id) {
            const cli = getData("clientes").find(c => c.id === id);
            document.getElementById("id").value = cli.id;
            document.getElementById("nombre").value = cli.nombre;
            document.getElementById("apellido").value = cli.apellido;
            document.getElementById("telefono").value = cli.telefono;
        }

        // Eliminar
        function eliminar(id) {
            if (!confirm("¿Eliminar cliente?")) return;

            let clientes = getData("clientes");
            const cli = clientes.find(c => c.id === id);

            clientes = clientes.filter(c => c.id !== id);
            setData("clientes", clientes);

            registrarAuditoria("Clientes", "Baja", `Eliminó cliente ${cli.nombre} ${cli.apellido}`);

            cargarTabla();
        }

        // Cancelar
        document.getElementById("cancelarBtn").addEventListener("click", limpiarFormulario);

        function limpiarFormulario() {
            document.getElementById("id").value = "";
            document.getElementById("nombre").value = "";
            document.getElementById("apellido").value = "";
            document.getElementById("telefono").value = "";
        }

        // Inicializar
        cargarTabla();
    </script>

</body>
</html>
