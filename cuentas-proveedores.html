<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPUMIN - Cuentas Proveedores</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Menú -->
    <div id="menu-container"></div>

    <main class="modulo-container">
        <h1>Cuentas Proveedores</h1>

        <!-- Formulario -->
        <section class="form-section">
            <input type="hidden" id="id">

            <label>Proveedor</label>
            <select id="proveedor"></select>

            <label>Monto ($)</label>
            <input type="number" id="monto" placeholder="Ej: 5000">

            <label>Detalle</label>
            <input type="text" id="detalle" placeholder="Ej: Pago parcial, factura 123">

            <button id="guardarBtn">Registrar Movimiento</button>
            <button id="cancelarBtn" class="btn-secundario">Cancelar</button>
        </section>

        <!-- Tabla -->
        <section class="tabla-section">
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Proveedor</th>
                        <th>Monto</th>
                        <th>Detalle</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaCuentas"></tbody>
            </table>
        </section>
    </main>

    <script src="js/core.js"></script>
    <script>
        protegerModulo();

        // Cargar menú
        fetch("menu.html")
            .then(r => r.text())
            .then(html => document.getElementById("menu-container").innerHTML = html);

        // Cargar proveedores
        function cargarProveedores() {
            const proveedores = getData("proveedores");
            const sel = document.getElementById("proveedor");
            sel.innerHTML = "";

            proveedores.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.nombre;
                opt.textContent = p.nombre;
                sel.appendChild(opt);
            });
        }

        // Renderizar tabla
        function cargarTabla() {
            const cuentas = getData("cuentasProveedores");
            const tbody = document.getElementById("tablaCuentas");
            tbody.innerHTML = "";

            cuentas.forEach(c => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${formatDate(c.fecha)}</td>
                    <td>${c.proveedor}</td>
                    <td>$ ${c.monto}</td>
                    <td>${c.detalle}</td>
                    <td>
                        <button onclick="eliminar('${c.id}')" class="btn-eliminar">Eliminar</button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Guardar movimiento
        document.getElementById("guardarBtn").addEventListener("click", () => {
            const proveedor = document.getElementById("proveedor").value;
            const monto = Number(document.getElementById("monto").value);
            const detalle = document.getElementById("detalle").value.trim();

            if (!proveedor || monto === 0) {
                alert("Complete proveedor y monto");
                return;
            }

            let cuentas = getData("cuentasProveedores");

            cuentas.push({
                id: generarID(),
                fecha: new Date().toISOString(),
                proveedor,
                monto,
                detalle
            });

            setData("cuentasProveedores", cuentas);

            registrarAuditoria("Cuentas Proveedores", "Alta", `Movimiento: ${proveedor} - $${monto}`);

            limpiarFormulario();
            cargarTabla();
        });

        // Eliminar movimiento
        function eliminar(id) {
            if (!confirm("¿Eliminar movimiento?")) return;

            let cuentas = getData("cuentasProveedores");
            const mov = cuentas.find(c => c.id === id);

            cuentas = cuentas.filter(c => c.id !== id);
            setData("cuentasProveedores", cuentas);

            registrarAuditoria("Cuentas Proveedores", "Baja", `Eliminó movimiento de ${mov.proveedor}`);

            cargarTabla();
        }

        // Cancelar
        document.getElementById("cancelarBtn").addEventListener("click", limpiarFormulario);

        function limpiarFormulario() {
            document.getElementById("monto").value = "";
            document.getElementById("detalle").value = "";
        }

        // Inicializar
        cargarProveedores();
        cargarTabla();
    </script>

</body>
</html>
