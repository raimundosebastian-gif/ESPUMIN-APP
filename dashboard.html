<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="js/core.js"></script>

    <style>
        .dashboard {
            max-width: 1100px;
            margin: 30px auto;
            padding: 10px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .kpi {
            background: #f5f5f5;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .kpi span {
            display: block;
            font-size: 26px;
            margin-top: 8px;
            color: #333;
        }

        .section-title {
            margin-top: 40px;
            margin-bottom: 10px;
            font-size: 22px;
            font-weight: bold;
        }

        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .quick-links a {
            display: block;
            padding: 14px;
            background: #eaeaea;
            border-radius: 8px;
            text-align: center;
            text-decoration: none;
            color: #333;
            font-weight: bold;
        }

        .quick-links a:hover {
            background: #dcdcdc;
        }

        .alerta {
            background: #ffe0e0;
            padding: 12px;
            border-left: 5px solid #d00;
            margin-bottom: 10px;
            border-radius: 6px;
        }
    </style>
</head>

<body onload="protegerModulo(); cargarDashboard();">

    <div class="dashboard">

        <h1>Dashboard General</h1>
        <p id="fechaHoy"></p>

        <!-- ALERTAS -->
        <div id="alertas"></div>

        <!-- KPIs -->
        <div class="section-title">Indicadores generales</div>
        <div class="kpi-grid">
            <div class="kpi">Ventas del día <span id="kpiVentasDia">-</span></div>
            <div class="kpi">Ventas del mes <span id="kpiVentasMes">-</span></div>
            <div class="kpi">Entregas pendientes <span id="kpiEntregasPendientes">-</span></div>
            <div class="kpi">Productos con bajo stock <span id="kpiStockBajo">-</span></div>
            <div class="kpi">Saldo de caja <span id="kpiCaja">-</span></div>
            <div class="kpi">Eventos próximos <span id="kpiEventos">-</span></div>
        </div>

        <!-- ACCESOS RÁPIDOS -->
        <div class="section-title">Accesos rápidos</div>
        <div class="quick-links">
            <a href="ventas.html">Ventas</a>
            <a href="compras.html">Compras</a>
            <a href="productos.html">Productos</a>
            <a href="inventario.html">Inventario</a>
            <a href="caja.html">Caja</a>
            <a href="logistica.html">Logística</a>
            <a href="produccion.html">Producción</a>
            <a href="agenda.html">Agenda</a>
            <a href="impuestos.html">Impuestos</a>
            <a href="auditoria.html">Auditoría</a>
        </div>

    </div>

    <script>
        function cargarDashboard() {
            document.getElementById("fechaHoy").innerText =
                "Hoy es " + new Date().toLocaleDateString("es-AR");

            cargarKPIs();
            cargarAlertas();
        }

        /* ============================
           KPIs
        ============================ */
        function cargarKPIs() {
            const ventas = getData("ventas");
            const hoy = new Date().toISOString().split("T")[0];
            const mesActual = new Date().toISOString().slice(0, 7);

            // Ventas del día
            const ventasDia = ventas
                .filter(v => v.fecha === hoy)
                .reduce((acc, v) => acc + (v.total || 0), 0);

            // Ventas del mes
            const ventasMes = ventas
                .filter(v => v.fecha.startsWith(mesActual))
                .reduce((acc, v) => acc + (v.total || 0), 0);

            // Entregas pendientes
            const entregasPendientes = getLogistica()
                .filter(e => e.estado === "pendiente").length;

            // Stock bajo
            const stockBajo = getData("productos")
                .filter(p => p.stock !== undefined && p.stock < 5).length;

            // Saldo de caja
            const caja = getCaja()
                .reduce((acc, m) => acc + (m.tipo === "ingreso" ? m.monto : -m.monto), 0);

            // Eventos próximos
            const eventos = getAgenda()
                .filter(ev => ev.fecha >= hoy)
                .slice(0, 5).length;

            document.getElementById("kpiVentasDia").innerText = formatCurrency(ventasDia);
            document.getElementById("kpiVentasMes").innerText = formatCurrency(ventasMes);
            document.getElementById("kpiEntregasPendientes").innerText = entregasPendientes;
            document.getElementById("kpiStockBajo").innerText = stockBajo;
            document.getElementById("kpiCaja").innerText = formatCurrency(caja);
            document.getElementById("kpiEventos").innerText = eventos;
        }

        /* ============================
           ALERTAS
        ============================ */
        function cargarAlertas() {
            const alertas = [];
            const hoy = new Date().toISOString().split("T")[0];

            // Stock bajo
            const stockBajo = getData("productos")
                .filter(p => p.stock !== undefined && p.stock < 5);
            if (stockBajo.length > 0) {
                alertas.push("Hay productos con bajo stock.");
            }

            // Entregas atrasadas
            const atrasadas = getLogistica()
                .filter(e => e.estado !== "entregado" && e.fecha < hoy);
            if (atrasadas.length > 0) {
                alertas.push("Hay entregas atrasadas.");
            }

            // Eventos del día
            const eventosHoy = getAgenda().filter(ev => ev.fecha === hoy);
            if (eventosHoy.length > 0) {
                alertas.push("Tenés eventos programados para hoy.");
            }

            // Mostrar alertas
            const cont = document.getElementById("alertas");
            cont.innerHTML = "";

            alertas.forEach(a => {
                const div = document.createElement("div");
                div.className = "alerta";
                div.innerText = a;
                cont.appendChild(div);
            });
        }
    </script>

</body>
</html>
