/* ============================================================
   DASHBOARD
   ============================================================ */

function calcularVentasHoy() {
    const ventas = obtenerVentas();
    const hoy = new Date().toLocaleDateString();

    const ventasHoy = ventas.filter(v =>
        new Date(v.id).toLocaleDateString() === hoy
    );

    const total = ventasHoy.reduce((t, v) => t + v.total, 0);

    return { total, cantidad: ventasHoy.length };
}

function calcularVentasMes() {
    const ventas = obtenerVentas();
    const ahora = new Date();
    const mes = ahora.getMonth();
    const anio = ahora.getFullYear();

    const ventasMes = ventas.filter(v => {
        const f = new Date(v.id);
        return f.getMonth() === mes && f.getFullYear() === anio;
    });

    const total = ventasMes.reduce((t, v) => t + v.total, 0);

    return { total, cantidad: ventasMes.length };
}

function obtenerTopProductos() {
    const ventas = obtenerVentas();
    const conteo = {};

    ventas.forEach(v => {
        v.items.forEach(i => {
            if (!conteo[i.producto]) conteo[i.producto] = { cantidad: 0, total: 0 };
            conteo[i.producto].cantidad += i.cantidad;
            conteo[i.producto].total += i.subtotal;
        });
    });

    return Object.entries(conteo)
        .map(([producto, datos]) => ({ producto, ...datos }))
        .sort((a, b) => b.cantidad - a.cantidad)
        .slice(0, 5);
}

function obtenerUltimasVentas() {
    return obtenerVentas()
        .sort((a, b) => b.id - a.id)
        .slice(0, 5);
}

function contarClientes() {
    return obtenerClientes().length;
}

function contarProductosActivos() {
    return obtenerProductos().filter(p => p.estado === "Activo").length;
}

function cargarDashboard() {
    // Ventas hoy
    const hoy = calcularVentasHoy();
    document.getElementById("ventas-hoy").innerHTML =
        `$${hoy.total} — ${hoy.cantidad} ventas`;

    // Ventas mes
    const mes = calcularVentasMes();
    document.getElementById("ventas-mes").innerHTML =
        `$${mes.total} — ${mes.cantidad} ventas`;

    // Clientes
    document.getElementById("clientes-activos").innerHTML =
        contarClientes();

    // Productos activos
    document.getElementById("productos-activos").innerHTML =
        contarProductosActivos();

    // Top productos
    const top = obtenerTopProductos();
    document.getElementById("top-productos").innerHTML =
        top.length === 0
            ? "<p>No hay ventas registradas.</p>"
            : top.map(t => `
                <div style="margin-bottom:10px;">
                    <strong>${t.producto}</strong> — ${t.cantidad} unidades — $${t.total}
                </div>
            `).join("");

    // Últimas ventas
    const ult = obtenerUltimasVentas();
    document.getElementById("ultimas-ventas").innerHTML =
        ult.length === 0
            ? "<p>No hay ventas registradas.</p>"
            : ult.map(v => `
                <div style="margin-bottom:10px;">
                    <strong>${new Date(v.id).toLocaleDateString()}</strong> —
                    ${v.cliente} — $${v.total}
                </div>
            `).join("");
}
