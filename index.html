<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Espumin - Lavandería & Tintorería</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2ecc71">

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f5f5f5; }

    :root {
      --azul: #3498db;
      --verde: #2ecc71;
      --blanco: #ffffff;
      --gris: #f5f5f5;
    }

    header {
      background: linear-gradient(90deg, var(--azul), var(--verde));
      color: var(--blanco);
      padding: 15px;
      text-align: center;
    }

    header img {
      max-width: 120px;
      margin-bottom: 5px;
    }

    main { padding: 10px 15px 30px; }

    h2 { margin-top: 15px; color: var(--azul); }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--azul);
      background: var(--blanco);
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-size: 14px;
      color: var(--azul);
      font-weight: bold;
    }

    .tab.active {
      background: var(--azul);
      color: var(--blanco);
    }

    .section { display: none; margin-top: 10px; }
    .section.active { display: block; }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 6px 0 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    button {
      padding: 10px;
      margin: 5px 0;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
    }

    .btn-primary {
      background: var(--verde);
      color: var(--blanco);
      width: 100%;
    }

    .btn-secondary {
      background: var(--azul);
      color: var(--blanco);
      width: 100%;
    }

    .btn-danger {
      background: #e74c3c;
      color: var(--blanco);
    }

    .item-line {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }

    .row { display: flex; gap: 8px; }
    .row > div { flex: 1; }

    .total-box {
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
      text-align: right;
      color: var(--azul);
    }

    .list-row {
      padding: 6px 4px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }

    .badge {
      background: var(--verde);
      color: var(--blanco);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 13px;
    }

    th {
      background: var(--azul);
      color: var(--blanco);
    }

    .orden-card {
      border: 1px solid #aaa;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 6px;
      background: #f8f8f8;
    }

    .orden-card button {
      margin-right: 8px;
      margin-top: 6px;
    }

/* Tarjetas */
.orden-card, .cliente-card, .producto-card {
  background: #ffffff;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

/* Botones */
button {
  background: #007bff;
  color: white;
  border: none;
  padding: 10px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

button:hover {
  background: #0056b3;
}

button.danger {
  background: #dc3545;
}

button.success {
  background: #28a745;
}

button.warning {
  background: #ffc107;
  color: black;
}

/* Inputs */
input, select {
  width: 100%;
  padding: 10px;
  margin: 6px 0 12px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
}

/* Secciones */
section {
  padding: 20px;
}

/* Títulos */
h2 {
  margin-bottom: 15px;
  color: #333;
}

  </style>
</head>

<script>
// =========================
// SPA - Cambiar de sección
// =========================
function mostrarSeccion(id) {
  document.querySelectorAll("section").forEach(sec => sec.style.display = "none");
  document.getElementById(id).style.display = "block";
}

<li onclick="mostrarSeccion('inicio')">Inicio</li>
<li onclick="mostrarSeccion('clientes')">Clientes</li>
<li onclick="mostrarSeccion('productos')">Productos</li>
<li onclick="mostrarSeccion('nueva-orden')">Nueva Orden</li>
<li onclick="mostrarSeccion('historial')">Historial</li>

// =========================
// CLIENTES
// =========================

function cargarClientes() {
  return JSON.parse(localStorage.getItem("clientes")) || [];
}

function guardarClientes(clientes) {
  localStorage.setItem("clientes", JSON.stringify(clientes));
}

function agregarCliente(nombre, telefono) {
  const clientes = cargarClientes();

  const nuevo = {
    id: "CLI-" + Date.now(),
    nombre,
    telefono
  };

  clientes.push(nuevo);
  guardarClientes(clientes);
  renderClientes();
  actualizarSelectorClientes();
}

function renderClientes() {
  const clientes = cargarClientes();
  const tabla = document.getElementById("tabla-clientes");

  if (!tabla) return;

  tabla.innerHTML = "";

  clientes.forEach(c => {
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${c.nombre}</td>
      <td>${c.telefono}</td>
    `;
    tabla.appendChild(fila);
  });
}

function actualizarSelectorClientes() {
  const clientes = cargarClientes();
  const selector = document.getElementById("cliente");

  if (!selector) return;

  selector.innerHTML = `<option value="">-- Sin seleccionar --</option>`;

  clientes.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.nombre;
    selector.appendChild(opt);
  });
}

// =========================
// PRODUCTOS
// =========================

function cargarProductos() {
  return JSON.parse(localStorage.getItem("productos")) || [];
}

function guardarProductos(productos) {
  localStorage.setItem("productos", JSON.stringify(productos));
}

function agregarProducto(nombre, precio) {
  const productos = cargarProductos();

  const nuevo = {
    id: "PRO-" + Date.now(),
    nombre,
    precio: Number(precio)
  };

  productos.push(nuevo);
  guardarProductos(productos);
  renderProductos();
  actualizarSelectorPrendas();
}

function renderProductos() {
  const productos = cargarProductos();
  const tabla = document.getElementById("tabla-productos");

  if (!tabla) return;

  tabla.innerHTML = "";

  productos.forEach(p => {
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${p.nombre}</td>
      <td>$${p.precio}</td>
    `;
    tabla.appendChild(fila);
  });
}

function actualizarSelectorPrendas() {
  const productos = cargarProductos();
  const contenedor = document.getElementById("selector-prendas");

  if (!contenedor) return;

  contenedor.innerHTML = "";

  productos.forEach(p => {
    const item = document.createElement("label");
    item.innerHTML = `
      <input type="checkbox" value="${p.nombre}" data-precio="${p.precio}">
      ${p.nombre} ($${p.precio})
      <br>
    `;
    contenedor.appendChild(item);
  });
}

// ----------------------
// LocalStorage
// ----------------------
function cargarOrdenes() {
  return JSON.parse(localStorage.getItem("ordenes")) || [];
}

function guardarOrdenes(ordenes) {
  localStorage.setItem("ordenes", JSON.stringify(ordenes));
}

// ----------------------
// Crear estructura de orden
// ----------------------
function crearEstructuraOrden(cliente, prendas, pagoInicial = 0) {
  const total = prendas.reduce((sum, p) => sum + p.precio, 0);

  return {
    id: "ORD-" + Date.now(),
    cliente,
    prendas,
    total,
    pagado: pagoInicial,
    estadoPago:
      pagoInicial >= total ? "pagado" :
      pagoInicial > 0 ? "parcial" : "no_pagado",
    estadoTrabajo: "pendiente",
    fechaIngreso: new Date().toISOString().split("T")[0],
    fechaTerminado: null,
    fechaEntrega: null
  };
}

// ----------------------
// Obtener prendas seleccionadas
// ----------------------
function obtenerPrendasSeleccionadas() {
  const checks = document.querySelectorAll("#selector-prendas input[type='checkbox']:checked");
  const prendas = [];

  checks.forEach(chk => {
    prendas.push({
      tipo: chk.value,
      precio: Number(chk.dataset.precio)
    });
  });

  return prendas;
}

// ----------------------
// Crear nueva orden
// ----------------------
function crearNuevaOrden() {
  const selectorCliente = document.getElementById("cliente").value;
  const nombreManual = document.getElementById("cliente-nombre").value;
  const telefonoManual = document.getElementById("cliente-telefono").value;

  let clienteNombre = "";
  let clienteTelefono = "";

  if (selectorCliente) {
    const clientes = cargarClientes();
    const cli = clientes.find(c => c.id === selectorCliente);
    clienteNombre = cli.nombre;
    clienteTelefono = cli.telefono;
  } else {
    if (!nombreManual) {
      alert("Debe seleccionar o ingresar un cliente.");
      return;
    }
    agregarCliente(nombreManual, telefonoManual);
    clienteNombre = nombreManual;
    clienteTelefono = telefonoManual;
  }

  const prendas = obtenerPrendasSeleccionadas();
  if (prendas.length === 0) {
    alert("Debe seleccionar al menos una prenda.");
    return;
  }

  const pagoInicial = Number(document.getElementById("pagoInicial").value || 0);

  const orden = crearEstructuraOrden(clienteNombre, prendas, pagoInicial);

  const ordenes = cargarOrdenes();
  ordenes.push(orden);
  guardarOrdenes(ordenes);

  renderOrdenes();

// =========================
// Filtros por estado
// =========================

function filtrarOrdenes(estado) {
  const ordenes = cargarOrdenes();
  let filtradas = ordenes;

  if (estado !== "todas") {
    filtradas = ordenes.filter(o => o.estadoTrabajo === estado);
  }

  renderOrdenes(filtradas);
}

  alert("Orden creada correctamente.");
}

// ----------------------
// Registrar pago
// ----------------------
function registrarPago(orden, monto) {
  orden.pagado += monto;

  if (orden.pagado >= orden.total) {
    orden.estadoPago = "pagado";
  } else if (orden.pagado > 0) {
    orden.estadoPago = "parcial";
  } else {
    orden.estadoPago = "no_pagado";
  }
}

// ----------------------
// Marcar trabajo terminado
// ----------------------
function marcarTerminado(orden) {
  orden.estadoTrabajo = "terminada";
  orden.fechaTerminado = new Date().toISOString().split("T")[0];
}

// ----------------------
// Entregar orden
// ----------------------
function entregarOrden(orden) {
  if (orden.estadoPago !== "pagado") {
    alert("Para entregar la ropa, la orden debe estar pagada en su totalidad.");
    return false;
  }

  orden.estadoTrabajo = "entregada";
  orden.fechaEntrega = new Date().toISOString().split("T")[0];
  return true;
}

// ----------------------
// Botones de acción
// ----------------------
function btnTerminar(id) {
  const ordenes = cargarOrdenes();
  const orden = ordenes.find(o => o.id === id);

  marcarTerminado(orden);
  guardarOrdenes(ordenes);
  renderOrdenes();
}

function btnPagar(id) {
  const monto = Number(prompt("Monto recibido:"));
  if (!monto) return;

  const ordenes = cargarOrdenes();
  const orden = ordenes.find(o => o.id === id);

  registrarPago(orden, monto);
  guardarOrdenes(ordenes);
  renderOrdenes();
}

function btnEntregar(id) {
  const ordenes = cargarOrdenes();
  const orden = ordenes.find(o => o.id === id);

  if (entregarOrden(orden)) {
    guardarOrdenes(ordenes);
    renderOrdenes();
  }
}

// ----------------------
// Render de órdenes
// ----------------------
function renderOrdenes(lista = null) {
  const ordenes = lista || cargarOrdenes();
  const contenedor = document.getElementById("lista-ordenes");
  contenedor.innerHTML = "";

  ordenes.forEach(orden => {
    const div = document.createElement("div");
    div.className = "orden-card";

    div.innerHTML = `
      <h3>${orden.cliente}</h3>
      <p><strong>Estado:</strong> ${orden.estadoTrabajo}</p>
      <p><strong>Pago:</strong> $${orden.pagado} / $${orden.total}</p>
      <button onclick="btnTerminar('${orden.id}')">Marcar terminado</button>
      <button onclick="btnPagar('${orden.id}')">Registrar pago</button>
      <button onclick="btnEntregar('${orden.id}')">Entregar</button>
    `;

    contenedor.appendChild(div);
  });
}

// =========================
// Inicialización
// =========================
document.addEventListener("DOMContentLoaded", () => {
  renderClientes();
  renderProductos();
  actualizarSelectorClientes();
  actualizarSelectorPrendas();
  renderOrdenes();
});

</script>
<body>

<header>
  <img src="logo.png" alt="Logo Espumin">
  <h1>Espumin</h1>
  <div style="font-size:14px;">Lavandería & Tintorería</div>
</header>

<div class="tabs">
  <div class="tab active" data-target="ordenes">Nueva orden</div>
  <div class="tab" data-target="clientes">Clientes</div>
  <div class="tab" data-target="productos">Productos</div>
  <div class="tab" data-target="historial">Historial</div>
</div>

<main>

  <!-- ORDENES -->
  <section id="ordenes" class="section active">
    <h2>Nueva Orden</h2>

    <label>Cliente:</label>
    <select id="cliente">
      <option value="">-- Sin seleccionar --</option>
    </select>

    <label>Nombre del cliente</label>
    <input type="text" id="cliente-nombre" placeholder="Nombre del cliente">

    <label>Teléfono (opcional)</label>
    <input type="text" id="cliente-telefono" placeholder="Teléfono">

    <label>Prendas:</label>
    <div id="selector-prendas">
      <label><input type="checkbox" value="Camisa" data-precio="1500"> Camisa ($1500)</label><br>
      <label><input type="checkbox" value="Pantalón" data-precio="2000"> Pantalón ($2000)</label><br>
      <label><input type="checkbox" value="Saco" data-precio="3000"> Saco ($3000)</label><br>
    </div>

    <label>Pago inicial:</label>
    <input type="number" id="pagoInicial" placeholder="0">

    <button onclick="crearNuevaOrden()">Crear Orden</button>


    <h3>Cliente</h3>

    <label>Seleccionar cliente guardado</label>
    <select id="selectCliente" onchange="onSeleccionCliente()">
      <option value="">-- Sin seleccionar --</option>
    </select>

    <input id="ordenClienteNombre" placeholder="Nombre del cliente">
    <input id="ordenClienteTelefono" placeholder="Teléfono">
    <input id="ordenClienteExtra" placeholder="Campo opcional">

    <h3>Productos</h3>
    <div id="ordenItems"></div>
    <button class="btn-secondary" onclick="agregarItemOrden()">Agregar producto</button>

    <div class="total-box">
      Total: $<span id="ordenTotal">0</span>
    </div>

    <button class="btn-primary" onclick="guardarOrden()">Guardar orden</button>
    <button class="btn-secondary" onclick="enviarWhatsApp()">Enviar por WhatsApp</button>
  </section>

<!-- CLIENTES -->
<section id="clientes" class="section" style="display: none;">
  <h2>Clientes</h2>

  <div class="cliente-card">
    <label>Nombre del cliente</label>
    <input type="text" id="cliente-nombre">

    <label>Teléfono</label>
    <input type="text" id="cliente-telefono">

    <button onclick="agregarCliente(
      document.getElementById('cliente-nombre').value,
      document.getElementById('cliente-telefono').value
    )">Agregar cliente</button>
  </div>

  <h3>Lista de clientes</h3>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Teléfono</th>
      </tr>
    </thead>
    <tbody id="tabla-clientes"></tbody>
  </table>
</section>

  <!-- PRODUCTOS -->
  <section id="productos" class="section">
    <h2>Productos</h2>

    <input id="productoId" type="hidden">
    <input id="productoCodigo" placeholder="Código">
    <input id="productoNombre" placeholder="Nombre">
    <input id="productoPrecio" placeholder="Precio" type="number">

    <button class="btn-primary" onclick="guardarProducto()">Guardar producto</button>
    <button class="btn-secondary" onclick="limpiarProductoForm()">Limpiar</button>

    <h3>Listado</h3>
    <div id="productosLista"></div>
  </section>

  <!-- HISTORIAL -->
<div style="margin-bottom: 15px;">
  <button onclick="filtrarOrdenes('todas')">Todas</button>
  <button onclick="filtrarOrdenes('pendiente')">Pendientes</button>
  <button onclick="filtrarOrdenes('terminada')">Terminadas</button>
  <button onclick="filtrarOrdenes('entregada')">Entregadas</button>
</div>

  <section id="historial" class="section">
    <h2>Historial de órdenes</h2>
    <div id="historialLista"></div>
    <div id="lista-ordenes"></div>
  </section>

</main>

<script>
/* ---------------------------
   SISTEMA DE ALMACENAMIENTO
----------------------------*/

function cargarLS(clave, def) {
  const d = localStorage.getItem(clave);
  if (!d) return def;
  try { return JSON.parse(d); } catch { return def; }
}

function guardarLS(clave, valor) {
  localStorage.setItem(clave, JSON.stringify(valor));
}

let clientes = cargarLS("esp_clientes", []);
let productos = cargarLS("esp_productos", []);
let ordenes  = cargarLS("esp_ordenes" , []);
let itemsOrden = [];

/* ---------------------------
   TABS
----------------------------*/

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.target).classList.add("active");

    if (tab.dataset.target === "clientes") renderClientes();
    if (tab.dataset.target === "productos") renderProductos();
    if (tab.dataset.target === "historial") renderHistorial();
    if (tab.dataset.target === "ordenes") {
      cargarSelectClientes();
      if (itemsOrden.length === 0) agregarItemOrden();
      renderItemsOrden();
    }
  });
});

<section id="inicio" style="display: block;">
  <h2>Bienvenido a ESPUMIN</h2>
  <p>Seleccione una opción del menú para comenzar.</p>
</section>

/* ---------------------------
   CLIENTES
----------------------------*/

// =========================
// CLIENTES
// =========================

function cargarClientes() {
  return JSON.parse(localStorage.getItem("clientes")) || [];
}

function guardarClientes(clientes) {
  localStorage.setItem("clientes", JSON.stringify(clientes));
}

function agregarCliente(nombre, telefono) {
  const clientes = cargarClientes();

  const nuevo = {
    id: "CLI-" + Date.now(),
    nombre,
    telefono
  };

  clientes.push(nuevo);
  guardarClientes(clientes);
  renderClientes();
  actualizarSelectorClientes();
}

function renderClientes() {
  const clientes = cargarClientes();
  const tabla = document.getElementById("tabla-clientes");

  if (!tabla) return;

  tabla.innerHTML = "";

  clientes.forEach(c => {
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${c.nombre}</td>
      <td>${c.telefono}</td>
    `;
    tabla.appendChild(fila);
  });
}

function actualizarSelectorClientes() {
  const clientes = cargarClientes();
  const selector = document.getElementById("cliente");

  if (!selector) return;

  selector.innerHTML = `<option value="">-- Sin seleccionar --</option>`;

  clientes.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.nombre;
    selector.appendChild(opt);
  });
}

function guardarCliente() {
  const id = document.getElementById("clienteId").value;
  const nombre = document.getElementById("clienteNombre").value.trim();
  const telefono = document.getElementById("clienteTelefono").value.trim();
  const extra = document.getElementById("clienteExtra").value.trim();

  if (!nombre || !telefono) {
    alert("Nombre y teléfono son obligatorios.");
    return;
  }

  if (id) {
    const c = clientes.find(cl => cl.id == id);
    if (c) {
      c.nombre = nombre;
      c.telefono = telefono;
      c.extra = extra;
    }
  } else {
    const nuevoId = clientes.length ? Math.max(...clientes.map(c => c.id)) + 1 : 1;
    clientes.push({ id: nuevoId, nombre, telefono, extra });
  }

  guardarLS("esp_clientes", clientes);
  limpiarClienteForm();
  renderClientes();
  cargarSelectClientes();
}

function limpiarClienteForm() {
  document.getElementById("clienteId").value = "";
  document.getElementById("clienteNombre").value = "";
  document.getElementById("clienteTelefono").value = "";
  document.getElementById("clienteExtra").value = "";
}

function editarCliente(id) {
  const c = clientes.find(cl => cl.id == id);
  if (!c) return;
  document.getElementById("clienteId").value = c.id;
  document.getElementById("clienteNombre").value = c.nombre;
  document.getElementById("clienteTelefono").value = c.telefono;
  document.getElementById("clienteExtra").value = c.extra || "";
}

function eliminarCliente(id) {
  if (!confirm("¿Eliminar cliente?")) return;
  clientes = clientes.filter(c => c.id != id);
  guardarLS("esp_clientes", clientes);
  renderClientes();
  cargarSelectClientes();
}

function renderClientes() {
  const cont = document.getElementById("clientesLista");
  if (!clientes.length) {
    cont.innerHTML = "<div class='small'>Sin clientes cargados.</div>";
    return;
  }
  let html = "";
  clientes.forEach(c => {
    html += `
      <div class="list-row">
        <strong>${c.nombre}</strong> (${c.telefono})<br>
        <span class="small">${c.extra || ""}</span>
        <div>
          <button class="btn-secondary" onclick="editarCliente(${c.id})">Editar</button>
          <button class="btn-danger" onclick="eliminarCliente(${c.id})">Eliminar</button>
        </div>
      </div>
    `;
  });
  cont.innerHTML = html;
}

function cargarSelectClientes() {
  const sel = document.getElementById("selectCliente");
  let html = `<option value="">-- Sin seleccionar --</option>`;
  clientes.forEach(c => {
    html += `<option value="${c.id}">${c.nombre} (${c.telefono})</option>`;
  });
  sel.innerHTML = html;
}

function onSeleccionCliente() {
  const id = document.getElementById("selectCliente").value;
  if (!id) return;
  const c = clientes.find(cl => cl.id == id);
  if (!c) return;
  document.getElementById("ordenClienteNombre").value = c.nombre;
  document.getElementById("ordenClienteTelefono").value = c.telefono;
  document.getElementById("ordenClienteExtra").value = c.extra || "";
}

/* ---------------------------
   PRODUCTOS
----------------------------*/

<!-- PRODUCTOS -->
<section id="productos" class="section" style="display: none;">
  <h2>Productos</h2>

  <div class="producto-card">
    <label>Nombre del producto</label>
    <input type="text" id="producto-nombre">

    <label>Precio</label>
    <input type="number" id="producto-precio">

    <button onclick="agregarProducto(
      document.getElementById('producto-nombre').value,
      document.getElementById('producto-precio').value
    )">Agregar producto</button>
  </div>

  <h3>Lista de productos</h3>

  <table>
    <thead>
      <tr>
        <th>Producto</th>
        <th>Precio</th>
      </tr>
    </thead>
    <tbody id="tabla-productos"></tbody>
  </table>
</section>


/* ---------------------------
   ORDENES
----------------------------*/

// =========================
// ÓRDENES
// =========================

function cargarOrdenes() {
  return JSON.parse(localStorage.getItem("ordenes")) || [];
}

function guardarOrdenes(ordenes) {
  localStorage.setItem("ordenes", JSON.stringify(ordenes));
}

function crearEstructuraOrden(cliente, prendas, pagoInicial = 0) {
  const total = prendas.reduce((sum, p) => sum + p.precio, 0);

  return {
    id: "ORD-" + Date.now(),
    cliente,
    prendas,
    total,
    pagado: pagoInicial,
    estadoPago:
      pagoInicial >= total ? "pagado" :
      pagoInicial > 0 ? "parcial" : "no_pagado",
    estadoTrabajo: "pendiente",
    fechaIngreso: new Date().toISOString().split("T")[0],
    fechaTerminado: null,
    fechaEntrega: null
  };
}

function obtenerPrendasSeleccionadas() {
  const checks = document.querySelectorAll("#selector-prendas input[type='checkbox']:checked");
  const prendas = [];

  checks.forEach(chk => {
    prendas.push({
      tipo: chk.value,
      precio: Number(chk.dataset.precio)
    });
  });

  return prendas;
}

function crearNuevaOrden() {
  const selectorCliente = document.getElementById("cliente").value;
  const nombreManual = document.getElementById("cliente-nombre").value;
  const telefonoManual = document.getElementById("cliente-telefono").value;

  let clienteNombre = "";
  let clienteTelefono = "";

  if (selectorCliente) {
    const clientes = cargarClientes();
    const cli = clientes.find(c => c.id === selectorCliente);
    clienteNombre = cli.nombre;
    clienteTelefono = cli.telefono;
  } else {
    if (!nombreManual) {
      alert("Debe seleccionar o ingresar un cliente.");
      return;
    }
    agregarCliente(nombreManual, telefonoManual);
    clienteNombre = nombreManual;
    clienteTelefono = telefonoManual;
  }

  const prendas = obtenerPrendasSeleccionadas();
  if (prendas.length === 0) {
    alert("Debe seleccionar al menos una prenda.");
    return;
  }

  const pagoInicial = Number(document.getElementById("pagoInicial").value || 0);

  const orden = crearEstructuraOrden(clienteNombre, prendas, pagoInicial);

  const ordenes = cargarOrdenes();
  ordenes.push(orden);
  guardarOrdenes(ordenes);

  renderOrdenes();
  alert("Orden creada correctamente.");
}

function registrarPago(orden, monto) {
  orden.pagado += monto;

  if (orden.pagado >= orden.total) {
    orden.estadoPago = "pagado";
  } else if (orden.pagado > 0) {
    orden.estadoPago = "parcial";
  } else {
    orden.estadoPago = "no_pagado";
  }
}

function marcarTerminado(orden) {
  orden.estadoTrabajo = "terminada";
  orden.fechaTerminado = new Date().toISOString().split("T")[0];
}

function entregarOrden(orden) {
  if (orden.estadoPago !== "pagado") {
    alert("Para entregar la ropa, la orden debe estar pagada en su totalidad.");
    return false;
  }

  orden.estadoTrabajo = "entregada";
  orden.fechaEntrega = new Date().toISOString().split("T")[0];
  return true;
}

function btnTerminar(id) {
  const ordenes = cargarOrdenes();
  const orden = ordenes.find(o => o.id === id);

  marcarTerminado(orden);
  guardarOrdenes(ordenes);
  renderOrdenes();
}

function btnPagar(id) {
  const monto = Number(prompt("Monto recibido:"));
  if (!monto) return;

  const ordenes = cargarOrdenes();
  const orden = ordenes.find(o => o.id === id);

  registrarPago(orden, monto);
  guardarOrdenes(ordenes);
  renderOrdenes();
}

function btnEntregar(id) {
  const ordenes = cargarOrdenes();
  const orden = ordenes.find(o => o.id === id);

  if (entregarOrden(orden)) {
    guardarOrdenes(ordenes);
    renderOrdenes();
  }
}

function renderOrdenes() {
  const ordenes = cargarOrdenes();
  const contenedor = document.getElementById("lista-ordenes");
  contenedor.innerHTML = "";

  ordenes.forEach(orden => {
    const div = document.createElement("div");
    div.className = "orden-card";

    div.innerHTML = `
      <h3>${orden.cliente}</h3>
      <p><strong>Estado:</strong> ${orden.estadoTrabajo}</p>
      <p><strong>Pago:</strong> $${orden.pagado} / $${orden.total}</p>
      <button class="warning" onclick="btnTerminar('${orden.id}')">Marcar terminado</button>
      <button class="success" onclick="btnPagar('${orden.id}')">Registrar pago</button>
      <button class="danger" onclick="btnEntregar('${orden.id}')">Entregar</button>
    `;

    contenedor.appendChild(div);
  });
}

function agregarItemOrden() {
  if (!productos.length) {
    alert("Primero cargá al menos un producto.");
    return;
  }
  itemsOrden.push({ productoId: productos[0].id, cantidad: 1 });
  renderItemsOrden();
}

function cambiarProductoItem(i, idProd) {
  itemsOrden[i].productoId = parseInt(idProd);
  renderItemsOrden();
}

function cambiarCantidadItem(i, cant) {
  let c = parseInt(cant);
  if (isNaN(c) || c <= 0) c = 1;
  itemsOrden[i].cantidad = c;
  renderItemsOrden();
}

function eliminarItemOrden(i) {
  itemsOrden.splice(i, 1);
  renderItemsOrden();
}

function renderItemsOrden() {
  const cont = document.getElementById("ordenItems");
  if (!itemsOrden.length) {
    cont.innerHTML = "<div class='small'>Sin productos. Use 'Agregar producto'.</div>";
    document.getElementById("ordenTotal").innerText = "0";
    return;
  }
  let html = "";
  let total = 0;
  itemsOrden.forEach((item, index) => {
    const p = productos.find(pr => pr.id == item.productoId);
    if (!p) return;
    const subtotal = p.precio * item.cantidad;
    total += subtotal;
    html += `
      <div class="item-line">
        <div class="row">
          <div>
            <select onchange="cambiarProductoItem(${index}, this.value)">
              ${productos.map(pr => `
                <option value="${pr.id}" ${pr.id==item.productoId?"selected":""}>
                  ${pr.nombre} ($${pr.precio.toFixed(2)})
                </option>`).join("")}
            </select>
          </div>
          <div>
            <input type="number" min="1" value="${item.cantidad}" 
                   onchange="cambiarCantidadItem(${index}, this.value)">
          </div>
        </div>
        <div class="row">
          <div class="small">Subtotal: $${subtotal.toFixed(2)}</div>
          <div style="text-align:right;">
            <button class="btn-danger" onclick="eliminarItemOrden(${index})">Quitar</button>
          </div>
        </div>
      </div>
    `;
  });
  cont.innerHTML = html;
  document.getElementById("ordenTotal").innerText = total.toFixed(2);
}

function guardarOrden() {
  const nombre = document.getElementById("ordenClienteNombre").value.trim();
  const telefono = document.getElementById("ordenClienteTelefono").value.trim();
  const extra = document.getElementById("ordenClienteExtra").value.trim();

  if (!nombre || !telefono) {
    alert("Nombre y teléfono del cliente son obligatorios.");
    return;
  }
  if (!itemsOrden.length) {
    alert("Agregá al menos un producto a la orden.");
    return;
  }

  let cliente = clientes.find(c => c.telefono == telefono);
  if (!cliente) {
    const nuevoId = clientes.length ? Math.max(...clientes.map(c => c.id)) + 1 : 
