<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Espumin - Lavandería & Tintorería</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2ecc71">

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f5f5f5; }

    :root {
      --azul: #3498db;
      --verde: #2ecc71;
      --blanco: #ffffff;
      --gris: #f5f5f5;
    }

    header {
      background: linear-gradient(90deg, var(--azul), var(--verde));
      color: var(--blanco);
      padding: 15px;
      text-align: center;
    }

    header img {
      max-width: 120px;
      margin-bottom: 5px;
    }

    main { padding: 10px 15px 30px; }

    h2 { margin-top: 15px; color: var(--azul); }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--azul);
      background: var(--blanco);
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-size: 14px;
      color: var(--azul);
      font-weight: bold;
    }

    .tab.active {
      background: var(--azul);
      color: var(--blanco);
    }

    .section { display: none; margin-top: 10px; }
    .section.active { display: block; }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 6px 0 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    button {
      padding: 10px;
      margin: 5px 0;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
    }

    .btn-primary {
      background: var(--verde);
      color: var(--blanco);
      width: 100%;
    }

    .btn-secondary {
      background: var(--azul);
      color: var(--blanco);
      width: 100%;
    }

    .btn-danger {
      background: #e74c3c;
      color: var(--blanco);
    }

    .item-line {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }

    .row { display: flex; gap: 8px; }
    .row > div { flex: 1; }

    .total-box {
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
      text-align: right;
      color: var(--azul);
    }

    .list-row {
      padding: 6px 4px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }

    .badge {
      background: var(--verde);
      color: var(--blanco);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 13px;
    }

    th {
      background: var(--azul);
      color: var(--blanco);
    }
  </style>
</head>

<body>

<header>
  <img src="logo.png" alt="Logo Espumin">
  <h1>Espumin</h1>
  <div style="font-size:14px;">Lavandería & Tintorería</div>
</header>

<div class="tabs">
  <div class="tab active" data-target="ordenes">Nueva orden</div>
  <div class="tab" data-target="clientes">Clientes</div>
  <div class="tab" data-target="productos">Productos</div>
  <div class="tab" data-target="historial">Historial</div>
</div>

<main>

  <!-- ORDENES -->
  <section id="ordenes" class="section active">
    <h2>Nueva orden</h2>

    <h3>Cliente</h3>

    <label>Seleccionar cliente guardado</label>
    <select id="selectCliente" onchange="onSeleccionCliente()">
      <option value="">-- Sin seleccionar --</option>
    </select>

    <input id="ordenClienteNombre" placeholder="Nombre del cliente">
    <input id="ordenClienteTelefono" placeholder="Teléfono">
    <input id="ordenClienteExtra" placeholder="Campo opcional">

    <h3>Productos</h3>
    <div id="ordenItems"></div>
    <button class="btn-secondary" onclick="agregarItemOrden()">Agregar producto</button>

    <div class="total-box">
      Total: $<span id="ordenTotal">0</span>
    </div>

    <button class="btn-primary" onclick="guardarOrden()">Guardar orden</button>
    <button class="btn-secondary" onclick="enviarWhatsApp()">Enviar por WhatsApp</button>
  </section>

  <!-- CLIENTES -->
  <section id="clientes" class="section">
    <h2>Clientes</h2>

    <input id="clienteId" type="hidden">
    <input id="clienteNombre" placeholder="Nombre">
    <input id="clienteTelefono" placeholder="Teléfono">
    <input id="clienteExtra" placeholder="Campo opcional">

    <button class="btn-primary" onclick="guardarCliente()">Guardar cliente</button>
    <button class="btn-secondary" onclick="limpiarClienteForm()">Limpiar</button>

    <h3>Listado</h3>
    <div id="clientesLista"></div>
  </section>

  <!-- PRODUCTOS -->
  <section id="productos" class="section">
    <h2>Productos</h2>

    <input id="productoId" type="hidden">
    <input id="productoCodigo" placeholder="Código">
    <input id="productoNombre" placeholder="Nombre">
    <input id="productoPrecio" placeholder="Precio" type="number">

    <button class="btn-primary" onclick="guardarProducto()">Guardar producto</button>
    <button class="btn-secondary" onclick="limpiarProductoForm()">Limpiar</button>

    <h3>Listado</h3>
    <div id="productosLista"></div>
  </section>

  <!-- HISTORIAL -->
  <section id="historial" class="section">
    <h2>Historial de órdenes</h2>
    <div id="historialLista"></div>
  </section>

</main>

<script>
/* ---------------------------
   SISTEMA DE ALMACENAMIENTO
----------------------------*/

function cargarLS(clave, def) {
  const d = localStorage.getItem(clave);
  if (!d) return def;
  try { return JSON.parse(d); } catch { return def; }
}

function guardarLS(clave, valor) {
  localStorage.setItem(clave, JSON.stringify(valor));
}

let clientes = cargarLS("esp_clientes", []);
let productos = cargarLS("esp_productos", []);
let ordenes  = cargarLS("esp_ordenes" , []);
let itemsOrden = [];

/* ---------------------------
   TABS
----------------------------*/

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.target).classList.add("active");

    if (tab.dataset.target === "clientes") renderClientes();
    if (tab.dataset.target === "productos") renderProductos();
    if (tab.dataset.target === "historial") renderHistorial();
    if (tab.dataset.target === "ordenes") {
      cargarSelectClientes();
      if (itemsOrden.length === 0) agregarItemOrden();
      renderItemsOrden();
    }
  });
});

/* ---------------------------
   CLIENTES
----------------------------*/

function guardarCliente() {
  const id = document.getElementById("clienteId").value;
  const nombre = document.getElementById("clienteNombre").value.trim();
  const telefono = document.getElementById("clienteTelefono").value.trim();
  const extra = document.getElementById("clienteExtra").value.trim();

  if (!nombre || !telefono) {
    alert("Nombre y teléfono son obligatorios.");
    return;
  }

  if (id) {
    const c = clientes.find(cl => cl.id == id);
    if (c) {
      c.nombre = nombre;
      c.telefono = telefono;
      c.extra = extra;
    }
  } else {
    const nuevoId = clientes.length ? Math.max(...clientes.map(c => c.id)) + 1 : 1;
    clientes.push({ id: nuevoId, nombre, telefono, extra });
  }

  guardarLS("esp_clientes", clientes);
  limpiarClienteForm();
  renderClientes();
  cargarSelectClientes();
}

function limpiarClienteForm() {
  document.getElementById("clienteId").value = "";
  document.getElementById("clienteNombre").value = "";
  document.getElementById("clienteTelefono").value = "";
  document.getElementById("clienteExtra").value = "";
}

function editarCliente(id) {
  const c = clientes.find(cl => cl.id == id);
  if (!c) return;
  document.getElementById("clienteId").value = c.id;
  document.getElementById("clienteNombre").value = c.nombre;
  document.getElementById("clienteTelefono").value = c.telefono;
  document.getElementById("clienteExtra").value = c.extra || "";
}

function eliminarCliente(id) {
  if (!confirm("¿Eliminar cliente?")) return;
  clientes = clientes.filter(c => c.id != id);
  guardarLS("esp_clientes", clientes);
  renderClientes();
  cargarSelectClientes();
}

function renderClientes() {
  const cont = document.getElementById("clientesLista");
  if (!clientes.length) {
    cont.innerHTML = "<div class='small'>Sin clientes cargados.</div>";
    return;
  }
  let html = "";
  clientes.forEach(c => {
    html += `
      <div class="list-row">
        <strong>${c.nombre}</strong> (${c.telefono})<br>
        <span class="small">${c.extra || ""}</span>
        <div>
          <button class="btn-secondary" onclick="editarCliente(${c.id})">Editar</button>
          <button class="btn-danger" onclick="eliminarCliente(${c.id})">Eliminar</button>
        </div>
      </div>
    `;
  });
  cont.innerHTML = html;
}

function cargarSelectClientes() {
  const sel = document.getElementById("selectCliente");
  let html = `<option value="">-- Sin seleccionar --</option>`;
  clientes.forEach(c => {
    html += `<option value="${c.id}">${c.nombre} (${c.telefono})</option>`;
  });
  sel.innerHTML = html;
}

function onSeleccionCliente() {
  const id = document.getElementById("selectCliente").value;
  if (!id) return;
  const c = clientes.find(cl => cl.id == id);
  if (!c) return;
  document.getElementById("ordenClienteNombre").value = c.nombre;
  document.getElementById("ordenClienteTelefono").value = c.telefono;
  document.getElementById("ordenClienteExtra").value = c.extra || "";
}

/* ---------------------------
   PRODUCTOS
----------------------------*/

function guardarProducto() {
  const id = document.getElementById("productoId").value;
  const codigo = document.getElementById("productoCodigo").value.trim();
  const nombre = document.getElementById("productoNombre").value.trim();
  const precio = parseFloat(document.getElementById("productoPrecio").value);

  if (!codigo || !nombre || isNaN(precio) || precio <= 0) {
    alert("Código, nombre y precio válido son obligatorios.");
    return;
  }

  if (id) {
    const p = productos.find(pr => pr.id == id);
    if (p) {
      p.codigo = codigo;
      p.nombre = nombre;
      p.precio = precio;
    }
  } else {
    const nuevoId = productos.length ? Math.max(...productos.map(p => p.id)) + 1 : 1;
    productos.push({ id: nuevoId, codigo, nombre, precio });
  }

  guardarLS("esp_productos", productos);
  limpiarProductoForm();
  renderProductos();
  renderItemsOrden();
}

function limpiarProductoForm() {
  document.getElementById("productoId").value = "";
  document.getElementById("productoCodigo").value = "";
  document.getElementById("productoNombre").value = "";
  document.getElementById("productoPrecio").value = "";
}

function editarProducto(id) {
  const p = productos.find(pr => pr.id == id);
  if (!p) return;
  document.getElementById("productoId").value = p.id;
  document.getElementById("productoCodigo").value = p.codigo;
  document.getElementById("productoNombre").value = p.nombre;
  document.getElementById("productoPrecio").value = p.precio;
}

function eliminarProducto(id) {
  if (!confirm("¿Eliminar producto?")) return;
  productos = productos.filter(p => p.id != id);
  guardarLS("esp_productos", productos);
  renderProductos();
  renderItemsOrden();
}

function renderProductos() {
  const cont = document.getElementById("productosLista");
  if (!productos.length) {
    cont.innerHTML = "<div class='small'>Sin productos cargados.</div>";
    return;
  }
  let html = "<table><tr><th>Código</th><th>Nombre</th><th>Precio</th><th>Acciones</th></tr>";
  productos.forEach(p => {
    html += `
      <tr>
        <td>${p.codigo}</td>
        <td>${p.nombre}</td>
        <td>$${p.precio.toFixed(2)}</td>
        <td>
          <button class="btn-secondary" onclick="editarProducto(${p.id})">Editar</button>
          <button class="btn-danger" onclick="eliminarProducto(${p.id})">Eliminar</button>
        </td>
      </tr>
    `;
  });
  html += "</table>";
  cont.innerHTML = html;
}

/* ---------------------------
   ORDENES
----------------------------*/

function agregarItemOrden() {
  if (!productos.length) {
    alert("Primero cargá al menos un producto.");
    return;
  }
  itemsOrden.push({ productoId: productos[0].id, cantidad: 1 });
  renderItemsOrden();
}

function cambiarProductoItem(i, idProd) {
  itemsOrden[i].productoId = parseInt(idProd);
  renderItemsOrden();
}

function cambiarCantidadItem(i, cant) {
  let c = parseInt(cant);
  if (isNaN(c) || c <= 0) c = 1;
  itemsOrden[i].cantidad = c;
  renderItemsOrden();
}

function eliminarItemOrden(i) {
  itemsOrden.splice(i, 1);
  renderItemsOrden();
}

function renderItemsOrden() {
  const cont = document.getElementById("ordenItems");
  if (!itemsOrden.length) {
    cont.innerHTML = "<div class='small'>Sin productos. Use 'Agregar producto'.</div>";
    document.getElementById("ordenTotal").innerText = "0";
    return;
  }
  let html = "";
  let total = 0;
  itemsOrden.forEach((item, index) => {
    const p = productos.find(pr => pr.id == item.productoId);
    if (!p) return;
    const subtotal = p.precio * item.cantidad;
    total += subtotal;
    html += `
      <div class="item-line">
        <div class="row">
          <div>
            <select onchange="cambiarProductoItem(${index}, this.value)">
              ${productos.map(pr => `
                <option value="${pr.id}" ${pr.id==item.productoId?"selected":""}>
                  ${pr.nombre} ($${pr.precio.toFixed(2)})
                </option>`).join("")}
            </select>
          </div>
          <div>
            <input type="number" min="1" value="${item.cantidad}" 
                   onchange="cambiarCantidadItem(${index}, this.value)">
          </div>
        </div>
        <div class="row">
          <div class="small">Subtotal: $${subtotal.toFixed(2)}</div>
          <div style="text-align:right;">
            <button class="btn-danger" onclick="eliminarItemOrden(${index})">Quitar</button>
          </div>
        </div>
      </div>
    `;
  });
  cont.innerHTML = html;
  document.getElementById("ordenTotal").innerText = total.toFixed(2);
}

function guardarOrden() {
  const nombre = document.getElementById("ordenClienteNombre").value.trim();
  const telefono = document.getElementById("ordenClienteTelefono").value.trim();
  const extra = document.getElementById("ordenClienteExtra").value.trim();

  if (!nombre || !telefono) {
    alert("Nombre y teléfono del cliente son obligatorios.");
    return;
  }
  if (!itemsOrden.length) {
    alert("Agregá al menos un producto a la orden.");
    return;
  }

  let cliente = clientes.find(c => c.telefono == telefono);
  if (!cliente) {
    const nuevoId = clientes.length ? Math.max(...clientes.map(c => c.id)) + 1 : 