<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - Ingreso</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>

<div id="menu-container"></div>

<main class="modulo-container">
    <h1>Ingreso de Inventario</h1>

    <button onclick="window.location.href='listado-inventario.html'" class="btn-volver">
        ← Volver al listado
    </button>

    <section class="form-section">
        <input type="hidden" id="id">

        <label for="producto">Producto</label>
        <select id="producto"></select>

        <label for="stock">Cantidad</label>
        <input type="number" id="stock" min="1" placeholder="Ej: 10">

        <button id="guardarBtn">Guardar</button>
        <button id="cancelarBtn" class="btn-secundario">Cancelar</button>
    </section>
</main>

<script src="../core.js"></script>
<script>
    protegerModulo("inventario");

    fetch("../menu.html")
        .then(r => r.text())
        .then(html => menu-container.innerHTML = html);

    function cargarProductos() {
        const productos = getData("productos");
        const sel = document.getElementById("producto");
        sel.innerHTML = "";

        productos.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.nombre;
            opt.textContent = p.nombre;
            sel.appendChild(opt);
        });
    }

    function cargarEdicion() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        if (!id) return;

        const item = getData("inventario").find(i => i.id === id);
        document.getElementById("id").value = item.id;
        document.getElementById("producto").value = item.producto;
        document.getElementById("stock").value = item.stock;
    }

    document.getElementById("guardarBtn").addEventListener("click", () => {
        const id = document.getElementById("id").value;
        const producto = document.getElementById("producto").value;
        const stock = Number(document.getElementById("stock").value);

        if (!producto || stock <= 0) {
            alert("Complete todos los campos");
            return;
        }

        let inventario = getData("inventario");

        if (id) {
            const item = inventario.find(i => i.id === id);
            item.producto = producto;
            item.stock = stock;

            registrarAuditoria("Inventario", "Edición", `Editó stock de ${producto}`);
        } else {
            inventario.push({
                id: generarID(),
                producto,
                stock
            });

            registrarAuditoria("Inventario", "Alta", `Ingreso de ${stock} unidades de ${producto}`);
        }

        setData("inventario", inventario);
        window.location.href = "listado-inventario.html";
    });

    document.getElementById("cancelarBtn").addEventListener("click", () => {
        window.location.href = "listado-inventario.html";
    });

    cargarProductos();
    cargarEdicion();
</script>

</body>
</html>
