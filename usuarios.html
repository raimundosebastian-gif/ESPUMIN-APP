<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPUMIN - Usuarios y Roles</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>


    

    <!-- Menú -->
    <div id="menu-container"></div>

    <main class="modulo-container">
        <h1>Usuarios y Roles</h1>

        <!-- Formulario -->
        <section class="form-section">
            <input type="hidden" id="id">

            <label for="usuario">Usuario</label>
            <input type="text" id="usuario" placeholder="Ej: juanperez">

            <label for="password">Contraseña</label>
            <input type="password" id="password" placeholder="Nueva contraseña">

            <label for="rol">Rol</label>
            <select id="rol">
                <option value="Administrador">Administrador</option>
                <option value="Ventas">Ventas</option>
                <option value="Compras">Compras</option>
                <option value="Producción">Producción</option>
                <option value="Logística">Logística</option>
                <option value="Caja">Caja</option>
                <option value="Auditoría">Auditoría</option>
            </select>

            <label for="activo">Estado</label>
            <select id="activo">
                <option value="true">Activo</option>
                <option value="false">Inactivo</option>
            </select>

            <button id="guardarBtn">Guardar Usuario</button>
            <button id="cancelarBtn" class="btn-secundario">Cancelar</button>
        </section>

        <!-- Tabla -->
        <section class="tabla-section">
            <table>
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaUsuarios"></tbody>
            </table>
        </section>
    </main>

    <script src="core.js"></script>
    <script>
        protegerModulo();

        // Cargar menú
        fetch("menu.html")
            .then(r => r.text())
            .then(html => document.getElementById("menu-container").innerHTML = html);

        // Renderizar tabla
        function cargarTabla() {
            const usuarios = getData("usuarios");
            const tbody = document.getElementById("tablaUsuarios");
            tbody.innerHTML = "";

            usuarios.forEach(u => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${u.usuario}</td>
                    <td>${u.rol}</td>
                    <td>${u.activo ? "Activo" : "Inactivo"}</td>
                    <td>
                        <button onclick="editar('${u.id}')">Editar</button>
                        <button onclick="eliminar('${u.id}')" class="btn-eliminar">Eliminar</button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Guardar usuario
        document.getElementById("guardarBtn").addEventListener("click", () => {
            const id = document.getElementById("id").value;
            const usuario = document.getElementById("usuario").value.trim();
            const password = document.getElementById("password").value.trim();
            const rol = document.getElementById("rol").value;
            const activo = document.getElementById("activo").value === "true";

            if (!usuario) {
                alert("El usuario es obligatorio");
                return;
            }

            let usuarios = getData("usuarios");

            if (id) {
                // Editar
                const item = usuarios.find(u => u.id === id);

                item.usuario = usuario;
                item.rol = rol;
                item.activo = activo;

                if (password) item.password = password;

                registrarAuditoria("Usuarios", "Edición", `Editó usuario ${usuario}`);
            } else {
                // Nuevo
                usuarios.push({
                    id: generarID(),
                    usuario,
                    password: password || "1234",
                    rol,
                    activo
                });

                registrarAuditoria("Usuarios", "Alta", `Creó usuario ${usuario}`);
            }

            setData("usuarios", usuarios);
            limpiarFormulario();
            cargarTabla();
        });

        // Editar
        function editar(id) {
            const u = getData("usuarios").find(x => x.id === id);

            document.getElementById("id").value = u.id;
            document.getElementById("usuario").value = u.usuario;
            document.getElementById("password").value = "";
            document.getElementById("rol").value = u.rol;
            document.getElementById("activo").value = u.activo ? "true" : "false";
        }

        // Eliminar
        function eliminar(id) {
            if (!confirm("¿Eliminar usuario?")) return;

            let usuarios = getData("usuarios");
            const u = usuarios.find(x => x.id === id);

            usuarios = usuarios.filter(x => x.id !== id);
            setData("usuarios", usuarios);

            registrarAuditoria("Usuarios", "Baja", `Eliminó usuario ${u.usuario}`);

            cargarTabla();
        }

        // Cancelar
        document.getElementById("cancelarBtn").addEventListener("click", limpiarFormulario);

        function limpiarFormulario() {
            document.getElementById("id").value = "";
            document.getElementById("usuario").value = "";
            document.getElementById("password").value = "";
        }

        // Inicializar
        cargarTabla();
    </script>

</body>
</html>
