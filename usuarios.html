/* ============================================================
   USUARIOS — MÓDULO PROFESIONAL Y UNIFICADO
============================================================ */

/* Usuario raíz protegido */
const USUARIO_RAIZ = {
    usuario: "EU",
    password: "Villatia1974",
    rol: "Admin",
    estado: "Activo"
};

/* Obtener usuarios */
function obtenerUsuarios() {
    let lista = JSON.parse(localStorage.getItem("usuarios")) || [];

    // Si el usuario raíz no existe, lo creamos
    const existeRaiz = lista.some(u => u.usuario === USUARIO_RAIZ.usuario);

    if (!existeRaiz) {
        lista.push(USUARIO_RAIZ);
        localStorage.setItem("usuarios", JSON.stringify(lista));
    }

    return lista;
}

/* Guardar usuarios */
function guardarUsuarios(lista) {
    localStorage.setItem("usuarios", JSON.stringify(lista));
}

/* ============================================================
   LISTAR USUARIOS
============================================================ */

function cargarUsuarios() {
    const cont = document.getElementById("lista-usuarios");
    if (!cont) return;

    const usuarios = obtenerUsuarios();

    if (usuarios.length === 0) {
        cont.innerHTML = "<p>No hay usuarios registrados.</p>";
        return;
    }

    let html = `
        <table>
            <tr>
                <th>Usuario</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
    `;

    usuarios.forEach(u => {
        const esRaiz = u.usuario === USUARIO_RAIZ.usuario;

        html += `
            <tr>
                <td>${u.usuario}</td>
                <td>${u.rol}</td>
                <td>${u.estado}</td>
                <td>
                    <button class="btn-editar" onclick="abrirModalEditarUsuario('${u.usuario}')">Editar</button>
                    ${esRaiz ? "" : `<button class="btn-eliminar" onclick="eliminarUsuario('${u.usuario}')">Eliminar</button>`}
                </td>
            </tr>
        `;
    });

    html += "</table>";
    cont.innerHTML = html;
}

/* ============================================================
   NUEVO USUARIO
============================================================ */

function abrirModalNuevoUsuario() {
    document.getElementById("modal-nuevo").style.display = "flex";
}

function cerrarModalNuevoUsuario() {
    document.getElementById("modal-nuevo").style.display = "none";
}

function guardarNuevoUsuario() {
    const usuario = document.getElementById("nuevo-usuario").value.trim();
    const password = document.getElementById("nuevo-password").value.trim();
    const rol = document.getElementById("nuevo-rol").value;

    if (!usuario || !password) {
        alert("Complete todos los campos.");
        return;
    }

    let usuarios = obtenerUsuarios();

    if (usuarios.some(u => u.usuario.toLowerCase() === usuario.toLowerCase())) {
        alert("Ese usuario ya existe.");
        return;
    }

    usuarios.push({
        usuario,
        password,
        rol,
        estado: "Activo"
    });

    guardarUsuarios(usuarios);
    cerrarModalNuevoUsuario();
    cargarUsuarios();
    alert("Usuario creado correctamente.");
}

/* ============================================================
   EDITAR USUARIO
============================================================ */

function abrirModalEditarUsuario(usuario) {
    const usuarios = obtenerUsuarios();
    const u = usuarios.find(x => x.usuario === usuario);

    if (!u) return;

    document.getElementById("edit-id").value = u.usuario;
    document.getElementById("edit-usuario").value = u.usuario;
    document.getElementById("edit-password").value = "";
    document.getElementById("edit-rol").value = u.rol;
    document.getElementById("edit-estado").value = u.estado;

    // Proteger usuario raíz
    if (u.usuario === USUARIO_RAIZ.usuario) {
        document.getElementById("edit-rol").disabled = true;
        document.getElementById("edit-estado").disabled = true;
    } else {
        document.getElementById("edit-rol").disabled = false;
        document.getElementById("edit-estado").disabled = false;
    }

    document.getElementById("modal-editar").style.display = "flex";
}

function cerrarModalEditarUsuario() {
    document.getElementById("modal-editar").style.display = "none";
}

function guardarEdicionUsuario() {
    const id = document.getElementById("edit-id").value;
    const usuarioNuevo = document.getElementById("edit-usuario").value.trim();
    const passwordNuevo = document.getElementById("edit-password").value.trim();
    const rolNuevo = document.getElementById("edit-rol").value;
    const estadoNuevo = document.getElementById("edit-estado").value;

    let usuarios = obtenerUsuarios();
    let u = usuarios.find(x => x.usuario === id);

    if (!u) return;

    // Proteger usuario raíz
    if (u.usuario === USUARIO_RAIZ.usuario) {
        u.usuario = USUARIO_RAIZ.usuario; // No permitir cambiar nombre
        u.rol = "Admin";
        u.estado = "Activo";
    } else {
        u.usuario = usuarioNuevo;
        u.rol = rolNuevo;
        u.estado = estadoNuevo;
    }

    if (passwordNuevo) {
        u.password = passwordNuevo;
    }

    guardarUsuarios(usuarios);
    cerrarModalEditarUsuario();
    cargarUsuarios();
    alert("Usuario actualizado correctamente.");
}

/* ============================================================
   ELIMINAR USUARIO
============================================================ */

function eliminarUsuario(usuario) {
    if (usuario === USUARIO_RAIZ.usuario) {
        alert("El usuario raíz no puede ser eliminado.");
        return;
    }

    if (!confirm("¿Eliminar este usuario?")) return;

    let usuarios = obtenerUsuarios();
    usuarios = usuarios.filter(u => u.usuario !== usuario);

    guardarUsuarios(usuarios);
    cargarUsuarios();
}
