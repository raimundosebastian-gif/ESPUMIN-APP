<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPUMIN - Ventas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Menú -->
    <div id="menu-container"></div>

    <main class="modulo-container">
        <h1>Ventas</h1>

        <!-- Formulario -->
        <section class="form-section">
            <input type="hidden" id="id">

            <label>Cliente</label>
            <select id="cliente"></select>

            <label>Producto</label>
            <select id="producto"></select>

            <label>Cantidad</label>
            <input type="number" id="cantidad" min="1" placeholder="Ej: 3">

            <label>Precio unitario ($)</label>
            <input type="number" id="precio" readonly>

            <label>Total ($)</label>
            <input type="number" id="total" readonly>

            <button id="guardarBtn">Registrar Venta</button>
            <button id="cancelarBtn" class="btn-secundario">Cancelar</button>
        </section>

        <!-- Tabla -->
        <section class="tabla-section">
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Producto</th>
                        <th>Cant.</th>
                        <th>Total</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaVentas"></tbody>
            </table>
        </section>
    </main>

    <script src="js/core.js"></script>
    <script>
        protegerModulo();

        // Cargar menú
        fetch("menu.html")
            .then(r => r.text())
            .then(html => document.getElementById("menu-container").innerHTML = html);

        // Cargar selects
        function cargarClientes() {
            const clientes = getData("clientes");
            const sel = document.getElementById("cliente");
            sel.innerHTML = "";

            clientes.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.nombre;
                opt.textContent = c.nombre;
                sel.appendChild(opt);
            });
        }

        function cargarProductos() {
            const productos = getData("productos");
            const sel = document.getElementById("producto");
            sel.innerHTML = "";

            productos.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.nombre;
                opt.textContent = p.nombre;
                sel.appendChild(opt);
            });

            actualizarPrecio();
        }

        // Actualizar precio según producto
        function actualizarPrecio() {
            const producto = document.getElementById("producto").value;
            const precios = getData("precios");
            const precio = precios.find(p => p.producto === producto);

            document.getElementById("precio").value = precio ? precio.precio : 0;
            actualizarTotal();
        }

        // Total
        function actualizarTotal() {
            const cant = Number(document.getElementById("cantidad").value);
            const precio = Number(document.getElementById("precio").value);
            document.getElementById("total").value = cant * precio;
        }

        document.getElementById("producto").addEventListener("change", actualizarPrecio);
        document.getElementById("cantidad").addEventListener("input", actualizarTotal);

        // Renderizar tabla
        function cargarTabla() {
            const ventas = getData("ventas");
            const tbody = document.getElementById("tablaVentas");
            tbody.innerHTML = "";

            ventas.forEach(v => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${formatDate(v.fecha)}</td>
                    <td>${v.cliente}</td>
                    <td>${v.producto}</td>
                    <td>${v.cantidad}</td>
                    <td>$ ${v.total}</td>
                    <td>
                        <button onclick="eliminar('${v.id}')" class="btn-eliminar">Eliminar</button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Guardar venta
        document.getElementById("guardarBtn").addEventListener("click", () => {
            const cliente = document.getElementById("cliente").value;
            const producto = document.getElementById("producto").value;
            const cantidad = Number(document.getElementById("cantidad").value);
            const precio = Number(document.getElementById("precio").value);
            const total = Number(document.getElementById("total").value);

            if (!cliente || !producto || cantidad <= 0) {
                alert("Complete todos los campos");
                return;
            }

            // Stock
            let inventario = getData("inventario");
            const item = inventario.find(i => i.producto === producto);

            if (!item || item.stock < cantidad) {
                alert("Stock insuficiente");
                return;
            }

            item.stock -= cantidad;
            setData("inventario", inventario);

            // Registrar venta
            let ventas = getData("ventas");
            ventas.push({
                id: generarID(),
                fecha: new Date().toISOString(),
                cliente,
                producto,
                cantidad,
                precio,
                total
            });
            setData("ventas", ventas);

            registrarAuditoria("Ventas", "Alta", `Vendió ${cantidad} x ${producto} a ${cliente}`);

            limpiarFormulario();
            cargarTabla();
        });

        // Eliminar venta
        function eliminar(id) {
            if (!confirm("¿Eliminar venta?")) return;

            let ventas = getData("ventas");
            const venta = ventas.find(v => v.id === id);

            // Devolver stock
            let inventario = getData("inventario");
            const item = inventario.find(i => i.producto === venta.producto);
            if (item) item.stock += venta.cantidad;
            setData("inventario", inventario);

            ventas = ventas.filter(v => v.id !== id);
            setData("ventas", ventas);

            registrarAuditoria("Ventas", "Baja", `Eliminó venta de ${venta.producto}`);

            cargarTabla();
        }

        // Cancelar
        document.getElementById("cancelarBtn").addEventListener("click", limpiarFormulario);

        function limpiarFormulario() {
            document.getElementById("cantidad").value = "";
            document.getElementById("total").value = "";
        }

        // Inicializar
        cargarClientes();
        cargarProductos();
        cargarTabla();
    </script>

</body>
</html>
